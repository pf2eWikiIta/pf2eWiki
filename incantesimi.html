<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incantesimi</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="wiki.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-light fixed-top shadow-sm">
        <div class="container-fluid">
        <a class="navbar-brand" href="/index.html">
            <img src="/favicon.ico" alt="Home" width="30" height="24">
        </a>
        <span class="navbar-brand mb-0 h1">INCANTESIMI</span>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav">
            <button class="btn btn-outline-success me-2" onclick='cambiaSezione("occulta")'>Occulta</button>
            <button class="btn btn-outline-success me-2" onclick='cambiaSezione("arcana")'>Arcana</button>
            <button class="btn btn-outline-success me-2" onclick='cambiaSezione("divina")'>Divina</button>
            <button class="btn btn-outline-success me-2" onclick='cambiaSezione("primordiale")'>Primordiale</button>
            <button class="btn btn-outline-success me-2" onclick='cambiaSezione("elementale")'>Elementale</button>
            <button class="btn btn-outline-success me-2" onclick='cambiaSezione("rituali")'>Rituali</button>
            <button class="btn btn-outline-success me-2" onclick='cambiaSezione("focus")'>Focus</button>
            <button class="btn btn-outline-success me-2" onclick='cambiaSezione("classeSpec")'>classeSpec</button>
            </div>
        </div>
        </div>
    </nav>

    <button class="btn btn-primary d-lg-none" id="sidebar-toggle" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas">
        ☰ Menu
    </button>

    <!-- Offcanvas Sidebar -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Navigazione</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div id="sidebar-mobile" class="bg-light p-3 border rounded shadow-sm"></div>
        </div>
    </div>
    <div class="container-fluid p-3">
        <div class="row">
            <div class="col-lg-3 d-none d-lg-block border-end p-3 vh-100 overflow-auto" id ="sidebar-desktop-container">
                <div id="sidebar-desktop"></div>
            </div>
            <div class="col-lg-9 p-3" id = "contenitore">
            </div>
        </div>
    </div>
        <script>

        function cambiaSezione(sezione) {
            const Arcana = document.getElementById("arcana");
            const Occulta = document.getElementById("occulta");
            const Divina = document.getElementById("divina");
            const Primordiale = document.getElementById("primordiale");
            const Elementale = document.getElementById("elementale");
            const Rituali = document.getElementById("rituali");
            const Focus = document.getElementById("focus");
            const ClasseSpec = document.getElementById("classeSpec");
            Arcana.classList.remove("attiva");
            Occulta.classList.remove("attiva");
            Divina.classList.remove("attiva");
            Primordiale.classList.remove("attiva");
            Elementale.classList.remove("attiva");
            Rituali.classList.remove("attiva");
            Focus.classList.remove("attiva");
            ClasseSpec.classList.remove("attiva");

            switch (sezione) {
                case "arcana":
                    Arcana.classList.add("attiva");
                    break;
                case "occulta":
                    Occulta.classList.add("attiva");
                    break;
                case "primordiale":
                    Primordiale.classList.add("attiva");
                    break;
                case "elementale":
                    Elementale.classList.add("attiva");
                    break;
                case "rituali":
                    Rituali.classList.add("attiva");
                    break;
                case "divina":
                    Divina.classList.add("attiva");
                    break;
                case "focus":
                    Focus.classList.add("attiva");
                    break;
                case "classeSpec":
                    ClasseSpec.classList.add("attiva");
                    break;
            }
        }

        document.addEventListener('click', function (e) {
    // Clic su un .btn o .nav-link dentro la collapse?
    const trigger = e.target.closest('#navbarNavAltMarkup .btn, #navbarNavAltMarkup .nav-link');
    if (!trigger) return;

    const menu = document.getElementById('navbarNavAltMarkup');
    if (!menu) return;

    // Se non è aperto, non fare nulla
    if (!menu.classList.contains('show')) return;

    // Chiudi SEMPRE l'istanza (creandola se serve)
    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(menu);
    bsCollapse.hide();
    });
    </script>
    <script type="module">
        import * as common from './common.js';
        await common.init();
        const htmlSidebar = common.creaSidebar();
        const isMobile = window.matchMedia('(max-width: 767.98px)').matches;
        if (isMobile) {
        // Gestione sidebar mobile
        common.render(document.getElementById("sidebar-mobile"), htmlSidebar);
        } else {
        // Gestione sidebar desktop
        common.render(document.getElementById("sidebar-desktop"), htmlSidebar);
        }
        common.aprireSidebar("incantesimi");

        let trad = ["arcana", "divina", "occulta", "primordiale", "elementale", "rituali", "focus", "classeSpec"];
        let cont = document.getElementById("contenitore");
        for(let i = 0; i < trad.length; i++) {
            let path = `./incantesimi/${trad[i]}.json`;
            let incantesimi = await common.trovaDati(path, ["Nome", "Liv"]);
            for(let j = 0; j < incantesimi[1].length - 1; j++)
                for(let k = j + 1; k < incantesimi[1].length; k++)
                    if(incantesimi[1][j] > incantesimi[1][k]) {
                        let temp = [incantesimi[0][j], incantesimi[1][j]];
                        incantesimi[0][j] = incantesimi[0][k];
                        incantesimi[1][j] = incantesimi[1][k];
                        incantesimi[0][k] = temp[0];
                        incantesimi[1][k] = temp[1];
                    }
            let nuovo = [];
            for(let k = 0; k < incantesimi[1].length; k++)
                    nuovo.push(incantesimi[1][k]);
            let j = 0;
            while (j < incantesimi[0].length) {
                let ind = [j,j+1];
                while(incantesimi[1][ind[0]] == (ind[1] > incantesimi[1].length?  -1 : incantesimi[1][ind[1]])) ind[1]++; 
                for(let k = ind[0]; k < ind[1] - 1; k++)
                    for(let h = k + 1; h < ind[1]; h++)
                        if(incantesimi[0][k] > incantesimi[0][h]) {
                        let temp = [incantesimi[0][h], incantesimi[1][h]];
                        incantesimi[0][h] = incantesimi[0][k];
                        incantesimi[1][h] = incantesimi[1][k];
                        incantesimi[0][k] = temp[0];
                        incantesimi[1][k] = temp[1];
                    }
                j = ind[1];
            }
            
            for(let j = 0;j < incantesimi[1].length; j++){
                let temp = `${incantesimi[1][j]}°`;
                if(incantesimi[1][j] == 0)
                    temp += "(trucchetto)";
                incantesimi[1][j] = temp;
            }
            common.render(cont, 
                `<div id="${trad[i]}" class="sezione">
                    <h2 class="mb-3">${common.capitalize(trad[i])}</h2>
                    ${common.creaTabella( incantesimi, ["Nome", "Livello"], true)}
                </div>`, true);
            
        }
        
        const urlParams = new URLSearchParams(window.location.search);
        const sez = urlParams.get('sezione');
        
        cambiaSezione(sez == null? "occulta" : sez);

        common.sBInit();
window.cerca = (valore) => {
            common.sBCerca(valore);
        };

        window.copia = (testo) => {
            common.copiaTesto(testo);
        }
    </script>
</body>
</html>