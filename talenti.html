<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talenti</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="wiki.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg fixed-top shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/index.html">
        <img src="/favicon.ico" alt="Home" width="30" height="24" class="me-2">
        TALENTI
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup">
        <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div class="navbar-nav ms-auto">
            <button class="btn btn-outline-success me-2" onclick='cambiaSezione("generali")'>Generali</button>
            <button class="btn btn-outline-success me-2" onclick='cambiaSezione("abilita")'>Abilità</button>
        </div>
        </div>
    </div>
    </nav>


    <button class="btn btn-primary d-lg-none" id="sidebar-toggle" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas">
        ☰ Menu
    </button>

    <!-- Offcanvas Sidebar -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Navigazione</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div id="sidebar-mobile" class="p-2"></div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-3 d-none d-lg-block border-end p-3 vh-100 overflow-auto" id ="sidebar-desktop-container">
                <div id="sidebar-desktop"></div>
            </div>
            <div class="col-lg-9 p-3" id="contenitore">
                <div id="generali" class="sezione">
                    <h2>Generali</h2>
                </div>
                <div id="abilita" class="sezione">
                    <h2>Abilita</h2>
                </div>
            </div>
        </div>
    </div>

    <script>    
    function cambiaSezione(sezione) {
        const Generali = document.getElementById("generali");
        const Abilita = document.getElementById("abilita");
        Generali.classList.remove("attiva");
        Abilita.classList.remove("attiva");

        switch (sezione) {
            case "generali":
            Generali.classList.add("attiva");
            break;
            case "abilita":
            Abilita.classList.add("attiva");
            break;
        }
    }

    document.addEventListener('click', function (e) {
    // Clic su un .btn o .nav-link dentro la collapse?
    const trigger = e.target.closest('#navbarNavAltMarkup .btn, #navbarNavAltMarkup .nav-link');
    if (!trigger) return;

    const menu = document.getElementById('navbarNavAltMarkup');
    if (!menu) return;

    // Se non è aperto, non fare nulla
    if (!menu.classList.contains('show')) return;

    // Chiudi SEMPRE l'istanza (creandola se serve)
    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(menu);
    bsCollapse.hide();
    });
    </script>
    <script type="module">
        import * as common from './common.js';
        await common.init();
        const htmlSidebar = common.creaSidebar();
        const isMobile = window.matchMedia('(max-width: 767.98px)').matches;
        if (isMobile) {
            common.render(document.getElementById("sidebar-mobile"),htmlSidebar);
        } else {
            common.render(document.getElementById("sidebar-desktop"),htmlSidebar);
        }
        
        common.aprireSidebar("generali");

        let pathGen = "./talenti/generali.json";
        let pathAb = "./talenti/abilita.json";
        let gen = await common.trovaDati(pathGen, ["Nome", "Tratti", "Liv", "Dettagli", "Desc", "Azione"]);
        let ab = await common.trovaDati(pathAb, ["Nome", "Tratti", "Liv", "Dettagli", "Desc", "Azione"]);

        function ordina(arr) {
		for(let i = 0; i < arr[2].length - 1; i++)
                for(let j = i+1; j < arr[2].length; j++)
                    if(arr[2][i] > arr[2][j]) 
                        for(let k = 0; k < arr.length; k++) {
                            let temp = arr[k][i];
                            arr[k][i] = arr[k][j];
                            arr[k][j] = temp;
                        }
            let j = 0;
            while (j < arr[0].length) {
                let ind = [j,j+1];
                while(arr[2][ind[0]] == (ind[1] > arr[2].length?  -1 : arr[2][ind[1]])) ind[1]++;

                for(let k = ind[0]; k < ind[1] - 1; k++)
                    for(let h = k + 1; h < ind[1]; h++)
                        if(arr[0][k] > arr[0][h])
                            for(let l = 0; l < arr.length; l++) {
                                let temp = arr[l][k];
                                arr[l][k] = arr[l][h];
                                arr[l][h] = temp;
                            }
                j = ind[1];
            }


            for(let i = 0; i < arr[4].length; i++) {
                arr[1][i] = arr[1][i].join(", ");
                arr[2][i] = `${arr[2][i]}`;
                if(arr[5][i]) {
                    let testo = common.controllaTesto(JSON.parse(arr[4][i].replaceAll("###", "")).desc);
                    if(testo.length > 130)
                        arr[4][i] = common.controllaTesto(testo).substring(0, 127) + "...";
                    else
                        arr[4][i] = testo;
                }
                else
                    if(arr[4][i].length > 130)
                        arr[4][i] = common.controllaTesto(arr[4][i]).substring(0, 127) + "...";
            }
            
            for(let i = 0; i < arr[3].length; i++) {   
                let ind = -1;
                for(let j = 0; j < arr[3][i].length && ind == -1; j++) {
                    if(arr[3][i][j].includes("Prerequisiti"))
                        ind = j;
                }
                arr[3][i] = ind == -1? "" : arr[3][i][ind].replace("++Prerequisiti++ ", "");
            }
		return arr;
	}
        console.log(ab[0].length);
        gen = ordina(gen);
        ab = ordina(ab);
            
        common.render(document.getElementById("generali"), await common.creaTabella(gen, ["Nome", "Tratti", "Livello", "Prerequisiti", "Descrizione"], true), true);
        common.render(document.getElementById("abilita"),await common.creaTabella(ab, ["Nome", "Tratti", "Livello", "Prerequisiti", "Descrizione"], true), true);

        const urlParams = new URLSearchParams(window.location.search);
        let sez = urlParams.get('sezione');
        cambiaSezione(sez == null ? "generali" : sez);

        common.sBInit();
window.cerca = (valore) => {
            common.sBCerca(valore);
        };

        window.copia = (testo) => {
            common.copiaTesto(testo);
        }
    </script>
</body>
</html>
