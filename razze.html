<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Razze</title>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="wiki.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-light fixed-top shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="/index.html">
        <img src="/favicon.ico" alt="Home" width="30" height="24">
      </a>
      <span class="navbar-brand mb-0 h1">RAZZE</span>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div class="navbar-nav">
          <button class="btn btn-outline-success me-2" onclick='cambiaSezione("ancestries")'>Ancestries</button>
          <button class="btn btn-outline-success me-2" onclick='cambiaSezione("heritage")'>Heritage</button>
          <button class="btn btn-outline-success" onclick='cambiaSezione("talentiRazza")'>Talenti</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Bottone mobile toggle sidebar -->
  <button class="btn btn-primary d-lg-none" id="sidebar-toggle" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas">
    ☰ Menu
  </button>

  <!-- Offcanvas Sidebar -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">Navigazione</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <div id="sidebar-mobile" class="bg-light p-3 border rounded shadow-sm"></div>
    </div>
  </div>

  <!-- Layout principale -->
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-3 d-none d-lg-block border-end p-3 vh-100 overflow-auto" id ="sidebar-desktop-container">
        <div id="sidebar-desktop"></div>
      </div>
      <div class="col-lg-9 p-3">
        <div id="Ancestries" class="sezione"></div>
        <div id="Heritage" class="sezione"></div>
        <div id="talentiRazza" class="sezione"></div>
      </div>
    </div>
  </div>

  <script>
    const Ancestries = document.getElementById("Ancestries");
    const Heritage = document.getElementById("Heritage");
    const Talenti = document.getElementById("talentiRazza");

    function cambiaSezione(sezione) {
      Ancestries.classList.remove("attiva");
      Heritage.classList.remove("attiva");
      Talenti.classList.remove("attiva");

      switch (sezione) {
        case "ancestries":
          Ancestries.classList.add("attiva");
          break;
        case "heritage":
          Heritage.classList.add("attiva");
          break;
        case "talentiRazza":
          Talenti.classList.add("attiva");
          break;
      }
      
    }
    document.addEventListener('click', function (e) {
    // Clic su un .btn o .nav-link dentro la collapse?
    const trigger = e.target.closest('#navbarNavAltMarkup .btn, #navbarNavAltMarkup .nav-link');
    if (!trigger) return;

    const menu = document.getElementById('navbarNavAltMarkup');
    if (!menu) return;

    // Se non è aperto, non fare nulla
    if (!menu.classList.contains('show')) return;

    // Chiudi SEMPRE l'istanza (creandola se serve)
    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(menu);
    bsCollapse.hide();
    });
  </script>

  <script type="module">
    import * as common from './common.js';
    const pathHeritage = "./data/razze/heritage.json";
    const pathTalenti = "./data/razze/talentiRazza.json";

    await common.init();
    const htmlSidebar = common.creaSidebar();
    const isMobile = window.matchMedia('(max-width: 992px)').matches;

    if (isMobile) {
      // Gestione sidebar mobile
      common.render(document.getElementById("sidebar-mobile"),htmlSidebar);
    } else {
      // Gestione sidebar desktop
      common.render(document.getElementById("sidebar-desktop"),htmlSidebar);
    }
    const urlParams = new URLSearchParams(window.location.search);
    let sezione = urlParams.get('sezione');
    const id = urlParams.get('id');
    if(sezione == undefined)
        sezione = "ancestries";
    cambiaSezione(sezione);
    if(id)
      common.aprireSidebar(id);
    else
      common.aprireSidebar(sezione);
    const col = ["Nome", "Desc"];
    common.creaTabella(await common.trovaDati("razze/ancestries.json", col), col, true, true, "Ancestries");

    const heritage = await common.restituisciDatoAttributi(pathHeritage, ["Razza"], ["Universale"]);
    let risultato = "";
    for (let i = 0; i < heritage.length; i++) {
      risultato += `
        <div class="card mb-3">
          <div class="card-body">
            <h3 id="${heritage[i].Nome}">-${common.controllaTesto(common.vR(heritage[i].Nome))}</h3>
            ${common.controllaTesto(heritage[i].Dettagli)}<br><br>
            <strong>Benefici:</strong><br>
            ${common.controllaTesto(heritage[i].Desc)}
          </div>
        </div>`;
    }
    common.render(Heritage,risultato);

    let talenti = await common.restituisciDatoAttributi(pathTalenti, ["Razza"], ["Universale"]);
    risultato = "";
    for(let i = 0; i < talenti.length - 1; i++)
      for(let j = i+1; j < talenti.length; j++)
        if(parseInt(talenti[i].Livello) > parseInt(talenti[j].Livello)) {
          let temp = talenti[i];
          talenti[i] = talenti[j];
          talenti[j] = temp;
        }

    for(let i = 0; i < talenti.length; i++)
      risultato += `
        <div class="card mb-3">
          <div class="card-body">
            <h3 id="${common.controllaTesto(talenti[i].Nome)}">${common.controllaTesto(talenti[i].Nome)}&nbsp;&nbsp;&nbsp;&nbsp;Livello ${talenti[i].Livello}</h3>
            ${common.creaGraficaTratti(talenti[i].Tratti)}
            ${common.controllaTesto(talenti[i].Desc)}
          </div>
        </div>`;
    common.render(Talenti,risultato);

    
    cambiaSezione(sezione);
    if (id) {
      const element = document.getElementById(id);
      if (element) {
        element.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    }

    common.sBInit();
window.cerca = (valore) => {
            common.sBCerca(valore);
        };

        window.copia = (testo) => {
            common.copiaTesto(testo);
        }
  </script>
</body>
</html>
