<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Razza</title>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="wiki.css">
</head>
<body>
  <nav class="navbar navbar-expand-lg bg-light fixed-top shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="/index.html">
        <img src="/favicon.ico" alt="Bootstrap" width="30" height="24">
      </a>
      <span class="navbar-brand mb-0 h1">RAZZE</span>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div class="navbar-nav">
          <button class="btn btn-outline-success me-2" onclick='aggiorna("./razze.html?sezione=ancestries")'>Ancestries</button>
          <button class="btn btn-outline-success me-2" onclick='aggiorna("./razze.html?sezione=heritage")'>Heritage universali</button>
          <button class="btn btn-outline-success me-2" onclick='aggiorna("./razze.html?sezione=talentiRazza")'>Talenti universali</button>
          <button class="btn btn-outline-success" onclick='cambiaSezione()' id="btnSezione">Talenti razza</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Bottone sidebar mobile -->
  <button class="btn btn-primary d-lg-none" id="sidebar-toggle" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas">☰ Menu</button>

  <!-- Sidebar offcanvas -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">Navigazione</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <div id="sidebar-mobile" class="p-2"></div>
    </div>
  </div>

  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-3 d-none d-lg-block border-end p-3 vh-100 overflow-auto" id ="sidebar-desktop-container">
        <div id="sidebar-desktop"></div>
      </div>

      <div class="col-lg-9 p-3">
        <div id="descRazza" class="sezione"></div>
        <div id="talenti" class="sezione"></div>
      </div>
    </div>
  </div>

  <script>
    
    
    let descVisible = false;
    function cambiaSezione() {
        const btn = document.getElementById("btnSezione");
        const desc = document.getElementById("descRazza");   
        const sezTalenti = document.getElementById("talenti"); 
        desc.classList.remove("attiva");
        sezTalenti.classList.remove("attiva");  
        descVisible = !descVisible;
        if(descVisible) {
            desc.classList.add("attiva");
            btn.innerHTML = "Talenti razza";
        } else {
            sezTalenti.classList.add("attiva");
            btn.innerHTML = "Descrizione razza";
        }
       
    } 
    document.addEventListener('click', function (e) {
    // Clic su un .btn o .nav-link dentro la collapse?
    const trigger = e.target.closest('#navbarNavAltMarkup .btn, #navbarNavAltMarkup .nav-link');
    if (!trigger) return;

    const menu = document.getElementById('navbarNavAltMarkup');
    if (!menu) return;

    // Se non è aperto, non fare nulla
    if (!menu.classList.contains('show')) return;

    // Chiudi SEMPRE l'istanza (creandola se serve)
    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(menu);
    bsCollapse.hide();
    });
    
  </script>

  <script type="module">
    import * as common from './common.js';

    const path = "./data/razze/ancestries.json";
    const pathHeritage = "./data/razze/heritage.json";
    const pathTalenti = "./data/razze/talentiRazza.json";

    await common.init();
    const htmlSidebar = common.creaSidebar();
    const isMobile = window.matchMedia('(max-width: 767.98px)').matches;

    if (isMobile) {
      // Gestione sidebar mobile
      common.render(document.getElementById("sidebar-mobile"),htmlSidebar);
    } else {
      // Gestione sidebar desktop
      common.render(document.getElementById("sidebar-desktop"),htmlSidebar);
    }

    const urlParams = new URLSearchParams(window.location.search);
    const idRazza = urlParams.get('id');

    const dati = await common.restituisciOggetto(path, idRazza);
    const heritage = await common.restituisciDatoAttributi(pathHeritage, ["Razza"], [idRazza.toLowerCase()]);

    inserisciDati(dati, heritage);

    function inserisciDati(dati, heritage) {
      let ab = dati.Abilita.map(a => `${common.controllaTesto(a)}<br>${common.htmlBottoneCopia(`{{14${a.substring(0, a.indexOf("@"))}}}${common.controllaTestoIncolla(a.substring(a.indexOf("@")))}`)}`).join("<br><br>");
      let her = heritage.map(h => `-<strong>${h.Nome}</strong><br>${common.controllaTesto(h.Desc)}<br>${common.htmlBottoneCopia(`++{{14${h.Nome}}}++@${common.controllaTestoIncolla(h.Desc)}`)}<br><br>`).join("");

      common.render(document.getElementById("descRazza"), `
        <h3>${dati.Nome}</h3>
        ${common.creaGraficaTratti(dati.Tratti)}<br>
        <strong>Descrizione:</strong> ${common.controllaTesto(dati.DescFisica)}<br>
        <strong>Hp:</strong> ${dati.HP}<br>
        <strong>Taglia:</strong> ${dati.Taglia}<br>
        <strong>Velocitá:</strong> ${common.controllaTesto(dati.Velocita)}<br>
        <strong>Boost caratteristiche:</strong> ${dati.Boost.join(", ")}<br>
        <strong>Difetto caratteristica:</strong> ${dati.Difetto}<br>
        <strong>Lingue:</strong> <br>${common.controllaTesto(dati.Lingua)}<br><br>
        <strong>Abilitá:</strong><br>${ab}<br>
        <br><h2>Heritage</h2>${her}`, true);
    }

    const talenti = await common.restituisciDatoAttributi(pathTalenti, ["Razza"], [idRazza]);

    let risultato = talenti.map(t => `
      <div class="card mb-3">
        <div class="card-body">
          ${t.Azione? common.controllaTesto(t.Desc): 
          `<h3 id="${common.controllaTesto(t.Nome)}">${common.controllaTesto(t.Nome)}&nbsp;&nbsp;&nbsp;&nbsp;Livello ${t.Livello}</h3>
          <div class="text-muted">${common.creaGraficaTratti(t.Tratti)}</div>
          <div>${common.controllaTesto(t.Desc)}</div>`}
          <br>
          ${common.htmlBottoneCopia(t.Azione? common.creaCopiaAzione(t.Desc): common.testoCopiaGenerico(t))}
        </div>
      </div>
      
      `).join("");

    common.render(document.getElementById("talenti"),risultato);

    window.aggiorna = function(path) {
      common.aggiornaUrl(path);
    }
    common.aprireSidebar(idRazza);
    common.sBInit();
window.cerca = (valore) => {
            common.sBCerca(valore);
        };

    cambiaSezione();

    window.copia = (testo) => {
            common.copiaTesto(testo);
        }
  </script>
</body>
</html>
